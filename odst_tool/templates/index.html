<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Downloader Web</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        spotify: '#1DB954'
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-900 text-white font-sans antialiased h-screen flex flex-col">

    <div class="container mx-auto p-4 max-w-4xl flex-1 flex flex-col">

        <!-- Header -->
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-3xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-green-400 to-blue-500">
                Music Downloader
            </h1>
            <div class="flex items-center gap-3">
                <span id="status" class="px-3 py-1 bg-gray-800 rounded-full text-sm text-gray-400">Ready</span>
                {% if has_cloud %}
                <button onclick="startSync()" class="text-blue-400 hover:text-white" title="Sync to Cloud">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                </button>
                {% endif %}
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Settings Panel (Hidden by default) -->
        <div id="settingsPanel" class="hidden bg-gray-800 p-6 rounded-lg shadow-lg mb-6 border border-gray-700">
            <h2 class="text-xl font-semibold mb-4 text-gray-300">Settings</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">General</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-1">Output Folder</label>
                        <input type="text" id="outputDir" value="{{ output_dir }}"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-400 mb-1">Spotify Keys (Use Client ID)</label>
                        <input type="text" id="clientId" placeholder="Client ID"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white mb-2">
                        <input type="password" id="clientSecret" placeholder="Client Secret"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white mb-2">
                        <p class="text-xs text-gray-500 mt-1">Status: <span
                                class="{{ 'text-green-500' if has_creds else 'text-red-500' }}">{{ 'Configured' if
                                has_creds else 'Not Set' }}</span></p>
                    </div>
                </div>

                <div>
                    <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">Cloud Syncy ‚òÅÔ∏è (R2)</h3>
                    <div class="mb-2">
                        <input type="text" id="r2Account" placeholder="Account ID"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                    </div>
                    <div class="mb-2">
                        <input type="text" id="r2Key" placeholder="Access Key ID"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                    </div>
                    <div class="mb-2">
                        <input type="password" id="r2Secret" placeholder="Secret Access Key"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                    </div>
                    <div class="mb-2">
                        <input type="text" id="r2Bucket" placeholder="Bucket Name"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white">
                    </div>
                    <button onclick="saveCloudSettings()"
                        class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-xs mt-1">Save Cloud Config</button>
                    <p class="text-xs text-gray-500 mt-1">Status: <span
                            class="{{ 'text-green-500' if has_cloud else 'text-red-500' }}">{{ 'Configured' if has_cloud
                            else 'Disabled' }}</span></p>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-700">
                <h3 class="text-sm font-bold text-gray-400 uppercase mb-2">Download Quality üéµ</h3>
                <div class="flex items-center gap-4">
                    <select id="downloadQuality" class="bg-gray-700 border border-gray-600 rounded px-3 py-2 text-white text-sm">
                        {% for key, profile in quality_profiles.items() %}
                        <option value="{{ key }}" {{ 'selected' if key == quality else '' }}>
                            {{ profile.label }}
                        </option>
                        {% endfor %}
                    </select>
                    <p class="text-xs text-gray-500">Affects file size and audio fidelity.</p>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-gray-700">
                <button onclick="saveSettings()"
                    class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded text-sm font-medium">Save Settings</button>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1 min-h-0">

            <!-- Left Column: Source Selection -->
            <div class="flex flex-col gap-4">

                <!-- Manual Input Only (Tabs Removed) -->
                <div class="border-b border-gray-700 mb-4">
                    <span
                        class="px-4 py-2 text-sm font-medium text-green-400 border-b-2 border-green-400 inline-block">Import
                        Songs</span>
                </div>

                <!-- Manual/Bulk Import View -->
                <div id="view-manual" class="bg-gray-800 p-6 rounded-lg shadow-lg">
                    <label class="block text-sm font-medium text-gray-400 mb-2">Paste YouTube/Spotify URLs or Song Names
                        (One per line)</label>
                    <textarea id="bulkInput" rows="10"
                        class="w-full bg-gray-700 border border-gray-600 rounded px-4 py-2 text-white mb-2 font-mono text-sm"
                        placeholder="https://open.spotify.com/track/...&#10;The Weeknd - Blinding Lights&#10;Daft Punk - One More Time"></textarea>

                    <div class="flex gap-2">
                        <button onclick="addBulk()"
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-medium">Add
                            to Queue</button>
                        <button onclick="document.getElementById('bulkInput').value=''"
                            class="bg-gray-700 hover:bg-gray-600 text-gray-300 px-4 py-2 rounded">Clear</button>
                    </div>
                </div>

                <!-- Logs -->
                <div class="bg-black p-4 rounded-lg font-mono text-xs flex-1 overflow-y-auto text-green-400 border border-gray-800 h-48 mt-4"
                    id="logs">
                    <div class="text-gray-600">-- System Logs --</div>
                </div>
            </div>

            <!-- Right Column: Queue -->
            <div class="flex flex-col bg-gray-800 rounded-lg shadow-lg overflow-hidden border border-gray-700">
                <div class="p-4 border-b border-gray-700 flex justify-between items-center bg-gray-850">
                    <div class="flex items-center gap-2">
                        <h2 class="font-semibold">Download Queue <span id="queueCount"
                                class="text-sm text-gray-400 font-normal ml-1">(0)</span></h2>
                        <span id="totalSize" class="text-xs bg-gray-700 text-blue-300 px-2 py-0.5 rounded">~ 0 MB</span>
                    </div>
                    <div class="flex gap-2 items-center">
                        <label class="flex items-center text-xs text-blue-300 mr-2 cursor-pointer">
                            <input type="checkbox" id="autoSync"
                                class="mr-1 form-checkbox bg-gray-700 border-gray-600 rounded text-blue-500">
                            Auto-Sync
                        </label>
                        <button onclick="clearQueue()" class="text-xs text-red-400 hover:text-white px-2">Clear</button>
                        <button onclick="startDownload()" id="startBtn"
                            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1 rounded text-sm disabled:opacity-50">
                            Start Download
                        </button>
                    </div>
                </div>

                <div class="flex-1 overflow-y-auto p-0" id="queueContainer">
                    <ul id="queueList" class="divide-y divide-gray-700">
                        <!-- Queue Items -->
                    </ul>
                    <div id="emptyMsg" class="h-full flex items-center justify-center text-gray-500">
                        Queue is empty
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const socket = io();
        let queue = []; // Stores objects {song_str, spotify_data?, estimated_mb?}

        // --- Socket Events ---
        socket.on('log', msg => {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.textContent = `> ${msg.data}`;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
        });

        socket.on('status', msg => {
            document.getElementById('status').textContent = msg.msg;
            const btn = document.getElementById('startBtn');
            if (msg.msg === 'Downloading...' || msg.msg === 'Syncing to Cloud...') {
                btn.disabled = true;
                btn.textContent = 'Running...';
            } else {
                btn.disabled = false;
                btn.textContent = 'Start Download';
            }
        });

        socket.on('add_to_queue', task => {
            addToQueueObj(task);
        });

        socket.on('item_done', msg => {
            // Attempt to find element by text content if ID matching is hard
            // Or just ignore UI update for individual success to save performance
            // Ideally we'd map ID to index. For now, let's just log it.
            // const el = document.getElementById(`item-${msg.id}`);
            // if (el) el.classList.add('text-green-500');
        });

        // --- Core Logic ---

        let renderTimer = null;

        function scheduleRender() {
            if (renderTimer) return;
            renderTimer = requestAnimationFrame(() => {
                renderQueue();
                renderTimer = null;
            });
        }

        function addToQueueObj(task) {
            // Ensure estimated_mb is present
            if (!task.estimated_mb) task.estimated_mb = 8.4;
            queue.push(task);
            scheduleRender();
        }

        function addBulk() {
            const input = document.getElementById('bulkInput');
            const text = input.value;
            if (!text.trim()) return;

            // Split by new lines and filter empty strings
            const songs = text.split('\n').filter(line => line.trim().length > 0);

            fetch('/queue/bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ songs: songs })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'ok') {
                        // Optimize: Add all to model first, then render once (handled by scheduleRender mostly, 
                        // but pushing array directly is faster)
                        d.items.forEach(item => {
                            if (!item.estimated_mb) item.estimated_mb = 8.4;
                            queue.push(item);
                        });
                        scheduleRender(); // Trigger ONE render for the whole batch
                        input.value = ''; // Clear input on success
                    }
                });
        }

        function renderQueue() {
            const list = document.getElementById('queueList');
            const emptyMsg = document.getElementById('emptyMsg');
            const count = document.getElementById('queueCount');
            const sizeLabel = document.getElementById('totalSize');

            list.innerHTML = '';
            count.textContent = `(${queue.length})`;

            // Calculate Total Size
            const totalMB = queue.reduce((acc, item) => acc + (item.estimated_mb || 0), 0);

            if (totalMB > 1024) {
                sizeLabel.textContent = `~ ${(totalMB / 1024).toFixed(2)} GB`;
            } else {
                sizeLabel.textContent = `~ ${totalMB.toFixed(1)} MB`;
            }

            if (queue.length === 0) {
                emptyMsg.style.display = 'flex';
            } else {
                emptyMsg.style.display = 'none';
                queue.forEach((item, idx) => {
                    // Performance: Only render first 200 items to keep DOM light
                    // (Queue still contains everything for download)
                    if (idx > 200) return;

                    const label = (typeof item === 'string') ? item : item.song_str;
                    const id = label; // Simplified ID
                    const size = item.estimated_mb ? `(${item.estimated_mb.toFixed(1)} MB)` : '';

                    const li = document.createElement('li');
                    li.id = `item-${idx}`; // Use Index for ID to avoid special char issues in querySelector
                    li.className = 'p-3 flex justify-between items-center text-sm hover:bg-gray-750 group';
                    li.innerHTML = `
                    <div class="truncate pr-4 flex-1">
                        <span>${label}</span>
                        <span class="text-xs text-gray-500 ml-2">${size}</span>
                    </div>
                    <button onclick="removeFromQueue(${idx})" class="text-gray-600 hover:text-red-400 opacity-0 group-hover:opacity-100 transition">√ó</button>
                `;
                    list.appendChild(li);
                });

                if (queue.length > 200) {
                    const li = document.createElement('li');
                    li.className = 'p-3 text-center text-xs text-gray-500 italic';
                    li.textContent = `...and ${queue.length - 200} more items...`;
                    list.appendChild(li);
                }
            }
        }

        function removeFromQueue(idx) {
            queue.splice(idx, 1);
            renderQueue();
        }

        function clearQueue() {
            queue = [];
            renderQueue();
        }

        function startDownload() {
            if (queue.length === 0) return alert('Queue is empty');
            const autoSync = document.getElementById('autoSync').checked;

            fetch('/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    queue: queue,
                    auto_sync: autoSync
                })
            });
        }

        // --- Settings & Spotify Logic ---

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            panel.classList.toggle('hidden');
        }

        function saveSettings() {
            const data = {
                output_dir: document.getElementById('outputDir').value,
                quality: document.getElementById('downloadQuality').value,
                client_id: document.getElementById('clientId').value,
                client_secret: document.getElementById('clientSecret').value
            };

            fetch('/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(r => r.json())
                .then(d => {
                    alert(d.msg);
                    location.reload(); // Reload to refresh auth state
                });
        }

        function saveCloudSettings() {
            const data = {
                account_id: document.getElementById('r2Account').value,
                access_key: document.getElementById('r2Key').value,
                secret_key: document.getElementById('r2Secret').value,
                bucket: document.getElementById('r2Bucket').value
            };

            fetch('/settings/cloud', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(r => r.json())
                .then(d => {
                    alert(d.msg);
                    location.reload();
                });
        }

        function startSync() {
            if (!confirm("Start Cloud Sync? This will merge local/remote libraries and upload new files.")) return;

            fetch('/sync', { method: 'POST' })
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'error') alert("Error: " + d.msg);
                });
        }

        function startOptimization() {
            const dryRun = document.getElementById('dryRun').checked;
            const mode = dryRun ? "Dry Run" : "LIVE";

            if (!dryRun && !confirm("Warning: This will PERMANENTLY reduce the quality of your library to 128kbps to save space. Proceed?")) return;

            toggleSettings(); // Close panel

            fetch('/optimize', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dry_run: dryRun })
            })
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'error') alert("Error: " + d.msg);
                });
        }

        function showTab(tab) {
            document.getElementById('view-manual').classList.add('hidden');
            document.getElementById('view-spotify').classList.add('hidden');
            document.getElementById('tab-manual').className = "px-4 py-2 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent";
            document.getElementById('tab-spotify').className = "px-4 py-2 text-sm font-medium text-gray-400 hover:text-white border-b-2 border-transparent";

            document.getElementById(`view-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = "px-4 py-2 text-sm font-medium text-green-400 border-b-2 border-green-400";
        }

        function fetchSpotify(type, id) {
            fetch('/queue/spotify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: type, id: id })
            });
        }

        function loadPlaylists() {
            const container = document.getElementById('playlistList');
            container.innerHTML = '<div class="text-center text-gray-500 py-4">Loading playlists...</div>';

            fetch('/spotify/playlists')
                .then(r => r.json())
                .then(data => {
                    if (data.error) {
                        container.innerHTML = `<div class="text-red-400 p-2 text-sm">${data.error}</div>`;
                        return;
                    }

                    container.innerHTML = '';
                    data.playlists.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center bg-gray-700 p-3 rounded hover:bg-gray-600 transition cursor-pointer';
                        div.innerHTML = `
                    <div>
                        <div class="font-medium text-sm">${p.name}</div>
                        <div class="text-xs text-gray-400">${p.count} tracks</div>
                    </div>
                    <button onclick="fetchSpotify('playlist', '${p.id}')" class="text-xs bg-green-600 px-3 py-1 rounded hover:bg-green-500">Load</button>
                `;
                        container.appendChild(div);
                    });
                });
        }
    </script>

</body>

</html>